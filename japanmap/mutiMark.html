<!DOCTYPE html>
<html>

<head>
    <title>Geocoding service</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
        /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */

        #map {
            height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #floating-panel {
            position: absolute;
            top: 10px;
            left: 25%;
            z-index: 5;
            background-color: #fff;
            padding: 5px;
            border: 1px solid #999;
            text-align: center;
            font-family: 'Roboto', 'sans-serif';
            line-height: 30px;
            padding-left: 10px;
        }

    </style>
    <script src="data.js"></script>
</head>

<body>
    <div id="floating-panel">
        <input id="address" type="textbox" placeholder="打地名搜尋看看這附近有沒有">
        <input id="submit" type="button" onClick="" value="搜尋">
        <div id="search-info"></div>
    </div>
    <div id="map"></div>
    <script>
        function initMap() {
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 8,
                center: {
                    lat: 36.173357,
                    lng: 138.515625
                }
            });

            var infowindow = new google.maps.InfoWindow();
            var urlnum = location.search.replace("?", "");
            currentzoom = map.getZoom();

            for (i = 0; i < data.length; i++) {
                var marker = new google.maps.Marker({
                    map: map,
                    icon: 'markerB.png',
                    position: new google.maps.LatLng(data[i].lat, data[i].lng),
                    name: data[i].name, //增加給 marker 物件
                    addr: data[i].addr,
                    area: data[i].city
                });
                markersArray.push(marker);
                google.maps.event.addListener(marker, 'click', function() {
                    var content = '<div class="popup_container"><h3>' + this.name + '</h3><p>地區：' + this.area + '</p><span>地址：' + this.addr + '</span></div>';
                    infowindow.open(map, this);
                    infowindow.setContent(content);
                }, false);
            }

            if (urlnum !== "") {
                var d = data[urlnum],
                    lat = d.lat,
                    lng = d.lng,
                    name = d.name,
                    area = d.city,
                    addr = d.addr,
                    latlng = new google.maps.LatLng(lat, lng);
                var content = '<div class="popup_container"><h3>' + name + '</h3><p>地區：' + area + '</p><span>地址：' + addr + '</span></div>';
                map.setCenter(latlng);
                map.setZoom(12);
                var marker = new google.maps.Marker({
                    map: map,
                    icon: 'markerY.png',
                    position: new google.maps.LatLng(lat, lng)
                });
                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.open(map, this);
                    infowindow.setContent(content);
                }, false);
                infowindow.open(map, marker);
                infowindow.setContent(content);
                //infowindow.setPosition(new google.maps.LatLng(lat+1, lng)); //直接開

            }

            document.getElementById('submit').addEventListener('click', function() {
                var address = document.getElementById('address').value;
                var set = new google.maps.Geocoder();
                setcenter(set, map, address, infowindow);
            });

            google.maps.event.addListener(map, 'zoom_changed', function(event) {
                currentzoom = map.getZoom();
            });
        }
        //------end of init

        var markersArray = [];
        //找最近點
        function rad(x) {
            return x * Math.PI / 180;
        }

        function find_closest_marker(map, searchloc, infowindow) {
            var lat = searchloc.lat();
            var lng = searchloc.lng();
            var R = 5000; // radius of earth in km
            var distances = [];
            var closest = -1;
            for (i = 0; i < markersArray.length; i++) {
                var mlat = markersArray[i].position.lat();
                var mlng = markersArray[i].position.lng();
                var dLat = rad(mlat - lat);
                var dLong = rad(mlng - lng);
                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(rad(lat)) * Math.cos(rad(lat)) * Math.sin(dLong / 2) * Math.sin(dLong / 2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                var d = R * c;
                distances[i] = d;
                if (closest == -1 || d < distances[closest]) {
                    closest = i;

                }
            }
            var blat = markersArray[closest].position.lat(),
                blng = markersArray[closest].position.lng(), content = '<p>距離您最近的ATM是：'+markersArray[closest].name+'</p><p>直線距離為：'+Math.round(distances[closest]*10)/10+'公里</p>'
            infowindow.setContent(content);
            infowindow.setPosition(new google.maps.LatLng(blat, blng));
            var searchinfo = document.getElementById('search-info');
            calcRoute(map, searchloc, markersArray[closest].position);
            infowindow.open(map);
            //searchinfo.innerHTML = markersArray[closest].name + distances[closest]
        }

        //繪製路線
        var Rarray = [];
        console.log(Rarray);

        function calcRoute(map, a, b) {
            var directionsService = new google.maps.DirectionsService();
            var directionsDisplay = new google.maps.DirectionsRenderer();
            var request = {
                origin: a,
                destination: b,
                travelMode: 'WALKING',
                unitSystem: google.maps.UnitSystem.IMPERIAL
            };
            directionsService.route(request, function(result, status) {
                
                if (status == 'OK') {
                    if (Rarray.length != 0) {
                        Rarray[0].setMap(null);
                    } //清除上一個
                    if(result.routes[0].legs[0] != undefined){
                       var myDistance = result.routes[0].legs[0].distance.value/1000+'公里';
                       console.log(myDistance);
                       }
                    
                    directionsDisplay.setDirections(result);
                    Rarray = []; //清空
                    Rarray.push(directionsDisplay);
                    Rarray[0].setMap(map);
                }
            });
        }

        //地址搜尋
        var Marray = [];

        function setcenter(geocoder, map, addrset, infowindow) {
            geocoder.geocode({
                'address': addrset
            }, function(results, status) {
                if (Marray.length != 0) {
                    Marray[0].setMap(null);
                } //清除上一個
                Marray = [];
                if (status === 'OK') {
                    map.setCenter(results[0].geometry.location);
                    //map.setZoom(currentzoom + 1);
                    var marker1 = new google.maps.Marker({
                        //map: map,
                        icon: 'walk.gif',
                        position: results[0].geometry.location
                    });
                    Marray.push(marker1);
                    Marray[0].setMap(map);
                    find_closest_marker(map, results[0].geometry.location,infowindow);
                } else {
                    alert('你確定有這地方? 錯誤訊息：' + status);
                }
            });

        }

        function deleteMarkers() {
            Marray = [];
        }

    </script>
    <!--script async defer src="https://maps.googleapis.com/maps/api/js?callback=initMap&key=AIzaSyDwDSYs7e92U9nP8IVodq-OEswsUlhCAdQ&signed_in=true">
    </script-->
    <script async defer src="https://maps.googleapis.com/maps/api/js?callback=initMap&libraries=places"></script>

</body>

</html>
