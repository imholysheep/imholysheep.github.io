<!DOCTYPE html>
<html>

<head>
    <title>Geocoding service</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
        /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */

        #map {
            height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #floating-panel {
            position: absolute;
            top: 10px;
            left: 25%;
            z-index: 5;
            background-color: #fff;
            padding: 5px;
            border: 1px solid #ccc;
            text-align: center;
            font-family: 'Microsoft JhengHei';
            line-height: 30px;
            padding-left: 10px;
            border-radius:10px;
            box-shadow: 0px 2px 1px rgba(0, 0, 0, 0.14);

        }
        #address{
            padding:5px;
            border: 1px solid #ccc;
        }
        .btn{
    border-radius: 6px;
    padding: 6px 20px;
    border: 0px;
    font-size: 12px;
    transition: 0.5s;
    text-decoration:none;
    font-family: 'Microsoft JhengHei';
    background: #3a5d7c;
    color:#fff;
}
.btn:hover{
    background: #0d385d;
}
#panel{
	position:absolute;
	left:25%;
	top:60px;
	z-index: 1;
    background-color: #fff;
    padding: 5px;
    border: 1px solid #ccc;
    text-align: center;
    font-family: 'Microsoft JhengHei';
    box-shadow: 0px 2px 1px rgba(0, 0, 0, 0.14);
				transition:.5s;
}
.hidden{
	opacity:0;
	top:10px !important;
}
    </style>
    <script src="data.js"></script>
</head>

<body>
    <div id="floating-panel">
        <input id="address" type="textbox" placeholder="鍵入地名搜尋最近ATM">
        <input id="submit" type="submit" value="搜尋" class="btn">
        <div id="search-info"></div>
    </div>
	<div id='panel' class="hidden"></div>
    <div id="map"></div>
    <script>
        function initMap() {
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 8,
                center: {
                    lat: 36.173357,
                    lng: 138.515625
                }
            });

            var infowindow = new google.maps.InfoWindow();
            var urlnum = location.search.replace("?", "");
            currentzoom = map.getZoom();

            for (i = 0; i < data.length; i++) {
                var marker = new google.maps.Marker({
                    map: map,
                    icon: 'img/markerG.png',
                    position: new google.maps.LatLng(data[i].lat, data[i].lng),
                    name: data[i].name, //增加給 marker 物件
                    addr: data[i].addr,
                    area: data[i].city
                });
                markersArray.push(marker);
                google.maps.event.addListener(marker, 'click', function() {
                    var content = '<div class="popup_container"><h3>' + this.name + '</h3><p>地區：' + this.area + '</p><span>地址：' + this.addr + '</span></div>';
                    infowindow.open(map, this);
                    infowindow.setContent(content);
                }, false);
            }

            if (urlnum !== "") {
                var d = data[urlnum],
                    lat = d.lat,
                    lng = d.lng,
                    name = d.name,
                    area = d.city,
                    addr = d.addr,
                    latlng = new google.maps.LatLng(lat, lng);
                var content = '<div class="popup_container"><h3>' + name + '</h3><p>地區：' + area + '</p><span>地址：' + addr + '</span></div>';
                map.setCenter(latlng);
                map.setZoom(12);
                var marker = new google.maps.Marker({
                    map: map,
                    icon: 'img/markerR.png',
                    position: new google.maps.LatLng(lat, lng)
                });
                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.open(map, this);
                    infowindow.setContent(content);
                }, false);
                infowindow.open(map, marker);
                infowindow.setContent(content);
                //infowindow.setPosition(new google.maps.LatLng(lat+1, lng)); //直接開

            }
            function search() {
                var address = document.getElementById('address').value;
                console.log('address', address);
                var set = new google.maps.Geocoder();  
                setcenter(set, map, address, infowindow);  
                return false;
            }
            //搜尋框
			function submit(){
				var inpt = document.getElementById('address');
				var sbmt = document.getElementById('submit');

				sbmt.addEventListener("click",function(){
				search();
				})
				if ( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
				alert("使用行動裝置!");
				}
				else {
				alert("使用桌上型裝置!");
				inpt.addEventListener("keypress",function(){
				if (event.keyCode==13){ search();}});
				}

			}
			submit();
            google.maps.event.addListener(map, 'zoom_changed', function(event) {
                currentzoom = map.getZoom();
            });
        }
        //------end of init

        var markersArray = [];
        //找最近點
        function rad(x) {
            return x * Math.PI / 180;
        }

        function find_closest_marker(map, searchloc, infowindow, marker) {
            var lat = searchloc.lat();
            var lng = searchloc.lng();
            var R = 6371; // 地球半徑
            var distances = [];
            var closest = -1;
            for (i = 0; i < markersArray.length; i++) {
                
                var mlat = markersArray[i].position.lat();
                var mlng = markersArray[i].position.lng();
                var dLat = rad(mlat - lat);
                var dLong = rad(mlng - lng);
                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(rad(lat)) * Math.cos(rad(lat)) * Math.sin(dLong / 2) * Math.sin(dLong / 2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                var d = R * c;
                distances[i] = d;
                if (closest == -1 || d < distances[closest]) {
                    closest = i;
                }
            }
			console.log(distances);
            var blat = markersArray[closest].position.lat(),
                blng = markersArray[closest].position.lng();
            var searchinfo = document.getElementById('search-info');
            if(distances[closest]<=10){
                calcRoute(map, searchloc, markersArray[closest], infowindow);
				panel('較近ATM及路線規劃僅供參考<br>請以實際路徑為主');
            }else{
                
                infowindow.setContent('您附近沒有可供跨國提款的ATM');
                infowindow.open(map, marker);
            }
            //searchinfo.innerHTML = markersArray[closest].name +'直線距離'+distances[closest]
        }

        //繪製路線
        var Rarray = [];
        console.log(Rarray);
        function calcRoute(map, a, b, infowindow) {
            var directionsService = new google.maps.DirectionsService();
            var directionsDisplay = new google.maps.DirectionsRenderer();
            var request = {
                origin: a,
                destination: b.position,
                travelMode: 'DRIVING',
                unitSystem: google.maps.UnitSystem.IMPERIAL
            };
            directionsService.route(request, function(result, status) {
                if (status == 'OK') {
                    var myDistance = result.routes[0].legs[0]; 
                    if (myDistance != undefined) {
                        myDistance = Math.round(result.routes[0].legs[0].distance.value / 100)/10 + '公里';
                    }else{
                        myDistance = '無法估算距離';
                    }
                    var content = '<p>距離您較近的ATM是：<b>' + b.name + '</b></p><p>地址：' + b.addr + '</p><p>距離為：' + myDistance + '</p>';
                    infowindow.setContent(content);
                    infowindow.setPosition(b.position);
                    infowindow.open(map);
                }else{
                    console.log(a.lat());
                    infowindow.setPosition(new google.maps.LatLng(a.lat(),a.lng()));
                    infowindow.setContent('沒有可用路徑');
                    infowindow.open(map);
                   
                }
                if (Rarray.length != 0) {
                    Rarray[0].setMap(null);
                } //清除上一個
                directionsDisplay.setDirections(result);
                Rarray = []; //清空
                Rarray.push(directionsDisplay);
                Rarray[0].setMap(map);
            });
        }

        //地址搜尋
        var Marray = [];

        function setcenter(geocoder, map, addrset, infowindow) {
            geocoder.geocode({
                'address': addrset
            }, function(results, status) {
                if (Marray.length != 0) {
                    Marray[0].setMap(null);
                } //清除上一個
                Marray = [];
                if (status === 'OK') {
                    map.setCenter(results[0].geometry.location);
                    //map.setZoom(currentzoom + 1);
                    var marker1 = new google.maps.Marker({
                        //map: map,
                        icon: 'img/walker.png',
                        position: results[0].geometry.location
                    });
                    Marray.push(marker1);
                    Marray[0].setMap(map);
                    find_closest_marker(map, results[0].geometry.location, infowindow, marker1);
                } else {
				 panel('很抱歉，找不到您所搜尋的地方!');
                
                }
            });

        }
		function panel(msg){
			var panel = document.getElementById('panel');
			panel.innerHTML=msg;
			panel.classList.remove('hidden');
				setTimeout(function() {
					panel.classList.add('hidden');  
                }, 3000);
		}
        function deleteMarkers() {
            Marray = [];
            console.log('Marray', Marray);
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?callback=initMap&key=AIzaSyDwDSYs7e92U9nP8IVodq-OEswsUlhCAdQ&signed_in=true">
    </script>
    <!--script async defer src="https://maps.googleapis.com/maps/api/js?callback=initMap&libraries=places"></script-->

</body>

</html>